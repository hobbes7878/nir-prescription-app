{% extends 'rx/base.html' %}

{% block title %}Data@thedetail{% endblock %}

{% block header %}
{% load staticfiles %}
<!-- Leaflet declarations -->
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
<!--[if lte IE 8]>
 <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
<![endif]-->
 <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>

<link rel="stylesheet"  media="all" type="text/css" href="{% static 'rx/css/jquery-ui.min.css' %}">
<link rel="stylesheet" href="{% static 'rx/css/gp_page.css' %}">
{% endblock %}





{% block content %}
<!-- Temp style -->
<style>
</style>
{% load humanize %}
{% load rx_extras %}


<div id="text_main">

<div id="gp_demographic">

	<div id="antimap">

		<div id="address_bar">
		{{gp_info.add1}}
		{{gp_info.add2}}
		{{gp_info.add3}}
		{{gp_info.postcode}}
		</div>
		<div id="demo_div">
			<div id="gp_name">
				{{gp_info.name|title|mcCap}}
			<!-- Fit font to div height -->
			<script>
			$(function() {
		    var div = $('#gp_name');
		    var fontSize = parseInt(div.css('font-size'));
		    do {
		        fontSize--;
		        div.css('font-size', fontSize.toString() + 'px');
		    } while (div.height() >= 100);});
			</script>


			</div>
			<div class="gp_demodata">
				<span class="head_cap">
					Registered Patients
				</span><br>	
				<span class="big_int">
					{{gp_info.patients|intcomma}}
				</span>
			</div>
			<div class="gp_demodata2">
				<span class="head_cap">
					Area Deprivation<span class="info" id="ideprive">&nbsp;<img src="{% static 'rx/image/i.png' %}" ></span>
				</span><br>
				<span class="deprived">
					{% if gp_info.deprive == '1' %}Least Deprived{% endif %}	
					{% if gp_info.deprive == '2' %}Less Deprived{% endif %}	
					{% if gp_info.deprive == '3' %}More Deprived{% endif %}	
					{% if gp_info.deprive == '4' %}Most Deprived{% endif %}	
				</span>
			</div>
		</div>

	</div>

	<div id="map">
	<script type="text/javascript">
	/*MAP*/
		var map = L.map('map',{zoomControl:false,
		scrollWheelZoom: false}).setView([{{gp_info.lat}},{{gp_info.lon}} ], 12);

		L.tileLayer('http://{s}.tile.cloudmade.com/e87822f63861499982c677d840781aa7/997/256/{z}/{x}/{y}.png', {
		    maxZoom:12

		}).addTo(map);

		var icon = L.icon({
			iconUrl: "{% static 'rx/image/Marker-Ball-Azure48.png' %}",
			iconAnchor: [22, 50],
			/*iconSize: [40, 55],*/
			popupAnchor: [15, -50],
		});
		var marker = L.marker([{{gp_info.lat}}, {{gp_info.lon}}], {icon: icon}).addTo(map);
	

	</script>
	</div>

</div>

<br>
<h4>Top Prescriptions: Antidepressant, Anti-anxiety & Analgesic Drugs</h4>
<div id="table_container">
<div id="table_div">
	<script type="text/javascript" src="{% static 'rx/js/jquery.tablesorter.js' %}"></script>
	<script type="text/javascript" src="{% static 'rx/js/jquery.tablesorter.scroller.js' %}"></script>
<table id="top_drug" class="tablesorter">	
	<thead class="zero">
		<tr class="upper_th">
			<td style="width:23px"></td>
			<td>Prescriptions</td>
		
			<td class="over_hd" colspan="3">Prescription Rate (Defined Daily Doses)</td>
		</tr>
		<tr class="lower_th">
			<th>Drug</th>
			<th>Written</th>
			
			<th><span class="table_sub"> Per 1,000 registered patients</span></th>
			<th><span class="table_sub"> Rank within Deprivation Group&nbsp;<span class="info" id="idgroup"><img src="{% static 'rx/image/i.png' %}" ></span></span></th>
			<th><span class="table_sub"> Rank among all N. Irish GPs&nbsp;<span class="info" ><img id="iagroup" src="{% static 'rx/image/i.png' %}" ></span></span></th>
		</tr>
	</thead>
	<tbody>
	{% for drug in top_drugs %}
		<tr  {% if forloop.counter|divisibleby:2 %}class='even'{% else %}class='odd'{% endif %} >
			<td class="td_drug"><a href="{% url 'rx.views.drug' drug.chem_name %}">{{drug.chem_name}}</a></td>
			<td class="td_rx">{{drug.prescripts|floatformat:0|intcomma}}</td>
			
			<td class="td_rate">{{drug.rx_per_1k|floatformat:1}}</td>
			<td class="td_dep_rank">{{drug.deprive_rank|ordinal}}<span class="table_sub"> / {{drug.deprive_group}}</span></td>
			<td class="td_rank">{{drug.all_rank|ordinal}}<span class="table_sub"> / {{drug.all_prescribing_gps}}</span></td>
		</tr>
	{% endfor %}
	</tbody>
</table>

<script>
		$.tablesorter.addParser({
	            id: "ordinalNumber",
	            is: function (s) {
	                return false;
	            },
	            format: function (s) {
	            	var regex = /^([0-9]+)[a-z]+/
	                return regex.exec(s)[1];
	            },
	            type: "numeric"
        	});
		$.tablesorter.addParser({
	            id: "cleanNumber",
	            is: function (s) {
	                return false;
	            },
	            format: function (s) {
	                return parseFloat(s.replace("Â£","").replace(",",""));
	            },
	            type: "numeric"
        	});
	$(document).ready(function() 
	    { 
	        $("#top_drug").tablesorter({
	        							headers :{
	        								1: {sorter:'cleanNumber'},
	        								2: {sorter:'cleanNumber'},
	        								4: {sorter:'ordinalNumber'},
	        								5: {sorter:'ordinalNumber'},
	        							},
	        							sortList: [[4,0]], 
	        							scrollHeight: 232,
	        							widgets: ['zebra', 'scroller']} ); 
	    } 
	);     
</script>

</div>
</div>

<br><br>






<div id="deprive_dialog" class="help_dialog" title="Area Deprivation"><p>Area deprivation is assigned according to the employment and income deprivation scores assessed by the Northern Ireland Statistics and Research Agency at the postcode of each GP. <br><br>Groups are determined by quartiles of deprivation scores and range: Most-More-Less-Least deprived.<br><br>The graph below explains further how the groups were determined.<br><br><hr><br><img src="{% static 'rx/image/zgroup.png' %}"></div>


<div id="dgroup_dialog" class="help_dialog" title="Deprivation Rank"><p>This GP's prescription rate ranked against all GPs within the same deprivation group that have prescribed this medicine.</div>

<div id="agroup_dialog" class="help_dialog" title="All GPs Rank"><p>This GP's prescription rate ranked against all other GPs that have prescribed this medicine in Northern Ireland.</div>


	


<script>
$(window).load(function () {

	$( "#deprive_dialog" ).dialog({ autoOpen: false, width: 540, maxHeight:500});
	$( "#ideprive" ).click(function() {
  		$( "#deprive_dialog" ).dialog( "open" );
	});

	$( "#cost_dialog" ).dialog({ autoOpen: false, width: 340, height:120  });
	$( "#icost" ).click(function() {
  		$( "#cost_dialog" ).dialog( "open" );
	});

	$( "#dgroup_dialog" ).dialog({ autoOpen: false, width: 400, height:140 });
	$( "#idgroup" ).click(function() {
  		$( "#dgroup_dialog" ).dialog( "open" );
	});

	$( "#agroup_dialog" ).dialog({ autoOpen: false, width: 400, height:140 });
	$( "#iagroup" ).click(function() {
  		$( "#agroup_dialog" ).dialog( "open" );
	});

});
</script>




</div>

{% endblock %}